package com.library;

import com.library.model.*;
import com.library.repository.*;
import com.library.service.*;

import java.util.Scanner;

public class LibraryApp {
    private final Scanner scanner = new Scanner(System.in);

    private final InMemoryAdminRepository adminRepo = new InMemoryAdminRepository();
    private final InMemoryBookRepository bookRepo = new InMemoryBookRepository();
    private final InMemoryMemberRepository memberRepo = new InMemoryMemberRepository();
    private final InMemoryLoanRepository loanRepo = new InMemoryLoanRepository();

    private final AdminService adminService = new AdminService(adminRepo);
    private final BookService bookService = new BookService(bookRepo);
    private final MemberService memberService = new MemberService(memberRepo);
    private final LoanService loanService = new LoanService(bookRepo, memberRepo, loanRepo);

    public static void main(String[] args) {
        new LibraryApp().run();
    }

    private void run() {
        mainAdmin(); // create default admin
        while (true) {
            showStartMenu();
        }
    }

    private void mainAdmin() {
        Admin defaultAdmin = new Admin("Victoria", "victoria123", "V123");
        adminRepo.save(defaultAdmin);
    }

    private void showStartMenu() {
        System.out.println("\n===== üìö WELCOME TO LIBRARY SYSTEM =====");
        System.out.println("1. üîê Sign In");
        System.out.println("2. üÜï Sign Up (Member)");
        System.out.println("0. üö™ Exit");
        System.out.print("üëâ Choose: ");
        String choice = scanner.nextLine();

        switch (choice) {
            case "1" -> showLoginTypeMenu();
            case "2" -> signUpMember();
            case "0" -> exitProgram();
            default -> System.out.println("‚ö†Ô∏è Invalid choice!");
        }
    }

    private void showLoginTypeMenu() {
        System.out.println("\nüîê Sign In as:");
        System.out.println("1. üë©‚Äçüíº Admin");
        System.out.println("2. üë§ Member");
        System.out.println("0. üîô Back");
        System.out.print("üëâ Choose: ");
        String choice = scanner.nextLine();

        switch (choice) {
            case "1" -> loginAdmin();
            case "2" -> loginMember();
            case "0" -> {}
            default -> System.out.println("‚ö†Ô∏è Invalid choice!");
        }
    }

    private void loginAdmin() {
        System.out.print("üë©‚Äçüíº Username: ");
        String user = scanner.nextLine();
        System.out.print("üîê Password: ");
        String pass = scanner.nextLine();
        adminService.login(user, pass);

        if (adminService.isLoggedIn()) {
            showAdminMenu();
        } else {
            System.out.println("‚ùå Login failed!");
        }
    }

    private void loginMember() {
        System.out.print("üë§ Enter member ID: ");
        String id = scanner.nextLine();
        Member member = memberService.findById(id);
        if (member != null) {
            System.out.println("‚úÖ Logged in as Member: " + member.getName());
            showMemberMenu(member);
        } else {
            System.out.println("‚ùå Member not found!");
        }
    }

    private void signUpMember() {
        System.out.println("üÜï Member Registration:");
        addMemberUI();
    }

    private void showAdminMenu() {
        while (adminService.isLoggedIn()) {
            System.out.println("\n===== üë©‚Äçüíº ADMIN MENU =====");
            System.out.println("1. üìö Book Management");
            System.out.println("2. üë• Member Management");
            System.out.println("3. üîÅ Loan Management");
            System.out.println("4. ‚ûï Add Admin");
            System.out.println("5. üîí Logout");
            System.out.print("üëâ Choose: ");
            String choice = scanner.nextLine();

            switch (choice) {
                case "1" -> manageBooks();
                case "2" -> manageMembers();
                case "3" -> manageLoans();
                case "4" -> registerAdminUI();
                case "5" -> adminService.logOut();
                default -> System.out.println("‚ö†Ô∏è Invalid choice!");
            }
        }
    }

    private void showMemberMenu(Member member) {
        while (true) {
            System.out.println("\n===== üë§ MEMBER MENU =====");
            System.out.println("1. üìñ Borrow Book");
            System.out.println("2. üì¶ Return Book");
            System.out.println("3. üîç Search by Title");
            System.out.println("4. üîç Search by ISBN");
            System.out.println("5. üîç Search by Author");
            System.out.println("6. üîç Search by Year");
            System.out.println("7. üìö View All Books");
            System.out.println("0. üîô Logout");
            System.out.print("üëâ Choose: ");
            String choice = scanner.nextLine();

            switch (choice) {
                case "1" -> lendBookAsMember(member);
                case "2" -> returnBookUI(member);
                case "3" -> {
                    System.out.print("Title: ");
                    bookService.searchBooksByTitle(scanner.nextLine()).forEach(System.out::println);
                }
                case "4" -> {
                    System.out.print("ISBN: ");
                    System.out.println(bookService.searchBookByISBN(scanner.nextLine()));
                }
                case "5" -> {
                    System.out.print("Author: ");
                    bookService.searchBooksByAuthor(scanner.nextLine()).forEach(System.out::println);
                }
                case "6" -> {
                    int year;
                    while (true) {
                        System.out.print("Year: ");
                        String input = scanner.nextLine();
                        try {
                            year = Integer.parseInt(input);
                            break; // valid input, break the loop
                        } catch (NumberFormatException e) {
                            System.out.println("Invalid input. Please enter a valid numeric year.");
                        }
                    }

                    bookService.searchByYear(year)
                            .forEach(System.out::println);
                }
                case "7" -> bookService.listAll().forEach(System.out::println);
                case "0" -> {
                    System.out.println("üëã Logged out.");
                    return;
                }
                default -> System.out.println("‚ö†Ô∏è Invalid choice!");

            }
        }
    }

    // Admin-Only: Add other Admins
    private void registerAdminUI() {
        if (adminService.isLoggedIn()) {
            System.out.print("Name of new Admin: ");
            String user = scanner.nextLine();
            System.out.print("Password: ");
            String pass = scanner.nextLine();
            System.out.print("Employee ID: ");
            String empId = scanner.nextLine();

            Admin newAdmin = new Admin(user, pass, empId);
            adminRepo.save(newAdmin);
            System.out.println("‚úÖ New admin added: " + user);
        } else {
            System.out.println("‚ö†Ô∏è Only main admin can add new admins!");
        }
    }

    // Book Management
    private void manageBooks() {
        System.out.println("\nüìö Book Management:");
        System.out.println("1. ‚ûï Add Book");
        System.out.println("2. ‚úèÔ∏è Edit Book");
        System.out.println("3. ‚ùå Delete Book");
        System.out.println("4. üîç Search by Title");
        System.out.println("5. üîç Search by ISBN");
        System.out.println("6. üîç Search by Author");
        System.out.println("7. üîç Search by Year");
        System.out.println("8. üìã List All Books");
        System.out.println("0. üîô Back");
        System.out.print("üëâ Choose: ");
        String choice = scanner.nextLine();

        switch (choice) {
            case "1" -> addBookUI();
            case "2" -> editBookUI();
            case "3" -> deleteBookUI();
            case "4" -> {
                System.out.print("Title: ");
                bookService.searchBooksByTitle(scanner.nextLine()).forEach(System.out::println);
            }
            case "5" -> {
                System.out.print("ISBN: ");
                System.out.println(bookService.searchBookByISBN(scanner.nextLine()));
            }
            case "6" -> {
                System.out.print("Author: ");
                bookService.searchBooksByAuthor(scanner.nextLine()).forEach(System.out::println);
            }
            case "7" -> {
                int year;
                while (true) {
                    System.out.print("Year: ");
                    String input = scanner.nextLine();
                    try {
                        year = Integer.parseInt(input);
                        break; // valid input, break the loop
                    } catch (NumberFormatException e) {
                        System.out.println("Invalid input. Please enter a valid numeric year.");
                    }
                }

                bookService.searchByYear(year)
                        .forEach(System.out::println);
            }
            case "8" -> bookService.listAll().forEach(System.out::println);
            case "0" -> {}
            default -> System.out.println("‚ö†Ô∏è Invalid choice!");
        }
    }

    private void addBookUI() {
        System.out.print("ISBN: ");
        String isbn = scanner.nextLine();
        System.out.print("Title: ");
        String title = scanner.nextLine();
        System.out.print("Author: ");
        String author = scanner.nextLine();
        System.out.print("Year: ");
        int year = Integer.parseInt(scanner.nextLine());
        System.out.print("Total Copies: ");
        int copies = Integer.parseInt(scanner.nextLine());
        bookService.addBook(new Book(title, author, year, isbn, copies));
        System.out.println("‚úÖ Book added!");
    }

    private void editBookUI() {
        System.out.print("Enter ISBN to edit: ");
        String isbn = scanner.nextLine();
        Book book = bookService.searchBookByISBN(isbn);
        if (book == null) {
            System.out.println("‚ùå Book not found.");
            return;
        }
        System.out.print("New Title (" + book.getTitle() + "): ");
        String newTitle = scanner.nextLine();
        if (!newTitle.isBlank()) book.setTitle(newTitle);
        System.out.print("New Author (" + book.getAuthor() + "): ");
        String newAuthor = scanner.nextLine();
        if (!newAuthor.isBlank()) book.setAuthor(newAuthor);
        bookService.editBook(book);
        System.out.println("‚úÖ Book updated!");
    }

    private void deleteBookUI() {
        System.out.print("Enter ISBN to remove: ");
        String isbn = scanner.nextLine();
        Book book = bookService.searchBookByISBN(isbn);
        if (book != null) {
            bookService.removeBook(book);
            System.out.println("‚úÖ Book removed!");
        } else {
            System.out.println("‚ùå Book not found.");
        }
    }

    // Member Management
    private void manageMembers() {
        System.out.println("\nüë• Member Management:");
        System.out.println("1. ‚ûï Add Member");
        System.out.println("2. ‚úèÔ∏è Edit Member");
        System.out.println("3. ‚ùå Delete Member");
        System.out.println("4. üìã List Members");
        System.out.println("0. üîô Back");
        System.out.print("üëâ Choose: ");
        String choice = scanner.nextLine();

        switch (choice) {
            case "1" -> addMemberUI();
            case "2" -> editMemberUI();
            case "3" -> deleteMemberUI();
            case "4" -> memberService.listAll().forEach(System.out::println);
            case "0" -> {}
            default -> System.out.println("‚ö†Ô∏è Invalid choice!");
        }
    }

    private void addMemberUI() {
        System.out.print("ID: ");
        String id = scanner.nextLine();
        System.out.print("Name: ");
        String name = scanner.nextLine();
        System.out.print("Age: ");
        int age = Integer.parseInt(scanner.nextLine());
        System.out.print("Email: ");
        String contact = scanner.nextLine();
        memberService.register(new Member(id, name, age, contact));
    }

    private void editMemberUI() {
        System.out.print("Enter ID to edit: ");
        String id = scanner.nextLine();
        Member m = memberService.findById(id);
        if (m == null) {
            System.out.println("‚ùå Member not found.");
            return;
        }
        System.out.print("New Name (" + m.getName() + "): ");
        String newName = scanner.nextLine();
        if (!newName.isBlank()) m.setName(newName);
        memberService.edit(m);
        System.out.println("‚úÖ Member updated.");
    }

    private void deleteMemberUI() {
        System.out.print("Enter ID to delete: ");
        String id = scanner.nextLine();
        memberService.delete(id);
        System.out.println("‚úÖ Member deleted.");
    }

    // Loans
    private void manageLoans() {
        System.out.println("\nüìñ Loan Management:");
        System.out.println("1. ‚ûï Borrow Book");
        System.out.println("2. üì¶ Return Book");
        System.out.println("0. üîô Back");
        System.out.print("üëâ Choose: ");
        String choice = scanner.nextLine();

        switch (choice) {
            case "1" -> lendBookUI();
            case "2" -> System.out.println("‚ö†Ô∏è Only members can return books from their own account.");
            case "0" -> {}
            default -> System.out.println("‚ö†Ô∏è Invalid choice!");
        }
    }

    private void lendBookUI() {
        System.out.print("Member ID: ");
        String mid = scanner.nextLine();
        Member member = memberService.findById(mid);
        if (member == null) {
            System.out.println("‚ùå Member with ID " + mid + " was not found.");
            return;
        }
        System.out.print("ISBN: ");
        String isbn = scanner.nextLine();
        String loanId = loanService.lendBook(mid, isbn);
        if (loanId != null) {
            System.out.println("‚úÖ Book lent. Loan ID: " + loanId);
        }
    }

    private void lendBookAsMember(Member member) {
        System.out.print("ISBN: ");
        String isbn = scanner.nextLine();
        String loanId = loanService.lendBook(member.getMembershipId(), isbn);
        if (loanId != null) {
            System.out.println("‚úÖ Book lent. Loan ID: " + loanId);
        }
    }

    private void returnBookUI(Member member) {
        var activeLoans = loanRepo.findActiveByMember(member.getMembershipId());
        if (activeLoans == null || activeLoans.isEmpty()) {
            System.out.println("‚ö†Ô∏è You have not borrowed any books yet.");
            System.out.println("üì≠ Your loan list is empty.");
            return;
        }
        System.out.print("Loan ID: ");
        String loanId = scanner.nextLine();
        int fine = loanService.returnBook(loanId);
        if (fine == -1) {
            System.out.println("‚ùó write the Loan ID correctly.");
            return;
        }
        if (fine > 0) {
            System.out.println("‚ö†Ô∏è Late return. Fine: " + fine + "‚Ç¨");
        } else {
            System.out.println("‚úÖ Book returned.");
        }
    }

    // Exit
    private void exitProgram() {
        System.out.println("üëã Goodbye!");
    }
}
